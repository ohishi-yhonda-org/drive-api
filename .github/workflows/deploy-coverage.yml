name: Sync to Public and Deploy Coverage

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-to-public:
    runs-on: [self-hosted, Windows, X64, test]
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Git and Push to Public
        run: |
          # Set Git path
          $env:PATH = "C:\Program Files\Git\bin;C:\Program Files\Git\cmd;" + $env:PATH
          
          # Configure git
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # Debug information
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Directory contents:"
          Get-ChildItem -Force | Select-Object Name, Mode
          
          
          # Get list of files marked for encryption in .gitattributes
          $encryptedFiles = @()
          if (Test-Path .gitattributes) {
            Get-Content .gitattributes | ForEach-Object {
              if ($_ -match '^(.+?)\s+filter=git-crypt') {
                $encryptedFiles += $matches[1]
              }
            }
            Write-Host "Files to be removed: $($encryptedFiles -join ', ')"
          }
          
          # Add public remote
          git remote add public https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/ohishi-yhonda-pub/drive-api.git -f 2>$null
          if ($LASTEXITCODE -ne 0) {
            git remote set-url public https://x-access-token:${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/ohishi-yhonda-pub/drive-api.git
          }
          
          # Create temporary branch
          git checkout -b temp-public-sync
          
          # Remove sensitive files
          foreach ($file in $encryptedFiles) {
            if (Test-Path $file) {
              Remove-Item $file -Force
              Write-Host "Removed: $file"
            }
          }
          
          # Remove .gitattributes
          if (Test-Path .gitattributes) {
            Remove-Item .gitattributes -Force
            Write-Host "Removed: .gitattributes"
          }
          
          # Stage all changes
          git add -A
          
          # Commit if there are changes
          $changes = git status --porcelain
          if ($changes) {
            git commit -m "Remove sensitive files for public repository"
          } else {
            Write-Host "No changes to commit"
          }
          
          # Push to public repository
          try {
            git push public temp-public-sync:main --force
            Write-Host "Successfully pushed to public repository"
          } catch {
            Write-Host "Push failed: $_"
            exit 1
          }

  deploy-coverage:
    needs: sync-to-public
    runs-on: [self-hosted, Windows, X64, test]
    steps:
      - name: Checkout public repository
        uses: actions/checkout@v4
        with:
          repository: ohishi-yhonda-pub/drive-api
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
      
      - name: Setup Git
        run: |
          $env:PATH = "C:\Program Files\Git\bin;C:\Program Files\Git\cmd;" + $env:PATH
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
      
      - name : set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Run tests and generate coverage
        run: npm run test:coverage
      
      - name: Deploy coverage to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          publish_dir: coverage
          publish_branch: gh-pages
          force_orphan: true
          external_repository: ohishi-yhonda-pub/drive-api
        env:
          PATH: "C:\\Program Files\\Git\\bin;C:\\Program Files\\Git\\cmd;${{ env.PATH }}"